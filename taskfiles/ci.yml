# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: 3

env:
  MIX_ENV: test

tasks:
  run:
    desc: Runs the ci pipeline locally
    # since this runs synchronously, it's best to order these by speed to get
    # the best "fail-fast" experience
    cmds:
      - task: deps:get
      - task: compile
      - task: xref
      - task: format:check
      - task: test
      - cmd: |
          echo ---------------------- | lolcrab
          echo Completed Successfully | lolcrab
          echo ---------------------- | lolcrab
        silent: true

  deps:get:
    desc: Downloads the Elixir dependencies
    cmd: mix deps.get

  compile:
    desc: Compiles the Elixir project, and fails on warnings
    cmd: mix compile --warnings-as-errors

  xref:
    desc: Check for cyclical compile dependencies
    cmd: mix xref graph --label compile-connected --fail-above 0

  test:
    desc: Runs the tests with fail-fast
    cmd: mix test --max-failures 1 --trace --warnings-as-errors

  format:check:
    desc: Runs the tests with fail-fast
    cmd: mix format --check-formatted
